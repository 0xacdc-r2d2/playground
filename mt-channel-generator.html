<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Meshtastic Config V12</title>
    <script src="https://unpkg.com/@meshtastic/js@2.5.16/dist/meshtastic.js"></script>
    <style>
        body { font-family: sans-serif; background: #121212; color: #eee; padding: 20px; }
        .card { background: #1e1e1e; border: 1px solid #333; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 5px solid #0078d4; }
        input, select, textarea { background: #2d2d2d; color: #fff; border: 1px solid #444; padding: 8px; border-radius: 4px; width: 100%; box-sizing: border-box; }
        .url-box { background: #000; color: #569cd6; padding: 15px; border: 1px dashed #0078d4; word-break: break-all; margin: 10px 0; font-family: monospace; cursor: pointer; }
        button { cursor: pointer; border: none; border-radius: 5px; padding: 10px; font-weight: bold; margin-top: 5px; }
        .btn-gen { background: #28a745; color: white; width: 100%; font-size: 1.2em; }
        .mqtt { font-size: 0.8em; color: #ffa500; display: flex; gap: 10px; margin-top: 10px; }
    </style>
</head>
<body>

    <h2>Meshtastic Config V12</h2>
    <div id="status" style="color: #ffa500; margin-bottom: 10px;">Lade Library...</div>
    
    <div id="channel-list"></div>
    <button onclick="addChannel()" style="background: #444; color: #fff;">+ Kanal hinzufügen</button>
    <button onclick="importData()" style="background: #0078d4; color: #fff;">Import (CLI/JSON)</button>

    <button class="btn-gen" onclick="generate()">URL GENERIEREN</button>

    <div class="url-box" id="url-out" onclick="copyUrl()">URL erscheint hier...</div>
    <textarea id="io" rows="8" placeholder="Output / Import hier..."></textarea>

<script>
    // Einfachster Zugriff auf die geladene Library
    let Lib;
    const check = setInterval(() => {
        Lib = window.meshtastic?.ChannelSet || window.Meshtastic?.ChannelSet;
        if (Lib) {
            document.getElementById('status').innerHTML = "Bereit ✅";
            document.getElementById('status').style.color = "#28a745";
            clearInterval(check);
        }
    }, 200);

    function addChannel(data = {}) {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
            <input type="text" class="name" placeholder="Name" value="${data.name || ''}" style="width:45%">
            <input type="text" class="psk" placeholder="PSK" value="${data.psk || 'AQ=='}" style="width:45%">
            <div class="mqtt">
                Präzision: <select class="prec" style="width: auto">
                    <option value="0" ${data.moduleSettings?.positionPrecision == 0 ? 'selected' : ''}>0 (Aus)</option>
                    <option value="16" ${data.moduleSettings?.positionPrecision == 16 ? 'selected' : ''}>16 (~150m)</option>
                    <option value="32" ${data.moduleSettings?.positionPrecision == 32 ? 'selected' : ''}>32 (Genau)</option>
                </select>
                <label><input type="checkbox" class="up" ${data.uplinkEnabled ? 'checked' : ''}> Uplink</label>
                <label><input type="checkbox" class="down" ${data.downlinkEnabled ? 'checked' : ''}> Downlink</label>
            </div>
        `;
        document.getElementById('channel-list').appendChild(div);
    }

    async function generate() {
        if (!Lib) return alert("Library noch nicht bereit!");
        const cards = document.querySelectorAll('.card');
        const set = { channels: [] };
        const json = [];

        cards.forEach((c, i) => {
            const pskB64 = c.querySelector('.psk').value;
            let pskBytes = new Uint8Array(0);
            try { if(pskB64) pskBytes = Uint8Array.from(atob(pskB64), c => c.charCodeAt(0)); } catch(e){}

            const chan = {
                index: i,
                role: i === 0 ? 1 : 2,
                settings: {
                    name: c.querySelector('.name').value,
                    psk: pskBytes,
                    uplinkEnabled: c.querySelector('.up').checked,
                    downlinkEnabled: c.querySelector('.down').checked
                },
                moduleSettings: { positionPrecision: parseInt(c.querySelector('.prec').value) }
            };
            set.channels.push(chan);
            json.push({...chan, role: i===0?"PRIMARY":"SECONDARY", psk: pskB64});
        });

        const buffer = Lib.encode(set).finish();
        const b64 = btoa(String.fromCharCode(...buffer)).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        document.getElementById('url-out').innerText = "https://www.meshtastic.org/d/#" + b64;
        document.getElementById('io').value = JSON.stringify(json, null, 2);
    }

    function importData() {
        const val = document.getElementById('io').value;
        let found = [];
        if (val.startsWith('[')) found = JSON.parse(val);
        else val.split('\n').forEach(l => {
            const m = l.match(/\{.*\}/);
            if (m) { 
                let j = JSON.parse(m[0]); 
                j.role = l.includes("PRIMARY") ? "PRIMARY" : "SECONDARY";
                found.push(j); 
            }
        });
        if (found.length) {
            document.getElementById('channel-list').innerHTML = "";
            found.forEach(addChannel);
        }
    }

    function copyUrl() { navigator.clipboard.writeText(document.getElementById('url-out').innerText); alert("Kopiert!"); }
    
    // Start mit Primary
    window.onload = () => addChannel({ role: "PRIMARY", psk: "AQ==" });
</script>
</body>
</html>
