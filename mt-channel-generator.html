<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Meshtastic Configurator V14</title>
    <script 
        src="https://cdn.jsdelivr.net/npm/@meshtastic/js@latest/dist/meshtastic.min.js" 
        crossorigin="anonymous">
    </script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #121212; color: #e0e0e0; padding: 20px; line-height: 1.5; }
        .container { max-width: 900px; margin: auto; }
        .status-indicator { padding: 10px; border-radius: 6px; margin-bottom: 20px; font-weight: bold; text-align: center; border: 1px solid transparent; }
        .loading { background: #332b00; color: #ffcc00; border-color: #554400; }
        .ready { background: #1b3320; color: #44ff66; border-color: #2d5a35; }
        .card { background: #1e1e1e; border: 1px solid #333; padding: 15px; margin-bottom: 15px; border-radius: 8px; border-left: 6px solid #444; position: relative; }
        .primary { border-left-color: #0078d4; }
        input, select { background: #2d2d2d; color: #fff; border: 1px solid #444; padding: 10px; border-radius: 4px; font-size: 14px; }
        .url-box { background: #000; color: #569cd6; padding: 15px; border: 1px dashed #0078d4; word-break: break-all; margin: 15px 0; font-family: 'Courier New', monospace; cursor: pointer; border-radius: 5px; }
        button { cursor: pointer; border: none; border-radius: 5px; padding: 10px 20px; font-weight: bold; transition: background 0.2s; }
        .btn-gen { background: #28a745; color: white; width: 100%; font-size: 1.1em; margin-top: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .btn-gen:hover { background: #218838; }
        .mqtt-row { display: flex; gap: 20px; align-items: center; margin-top: 10px; background: #252525; padding: 10px; border-radius: 4px; font-size: 0.9em; }
        textarea { background: #1a1a1a; color: #00ff41; width: 100%; height: 160px; border: 1px solid #333; font-family: 'Consolas', monospace; padding: 12px; box-sizing: border-box; margin-top: 15px; border-radius: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Meshtastic Channel Generator <span style="color: #0078d4;">V14</span></h2>
    <div id="status" class="status-indicator loading">Initialisiere Library (Warte auf CDN)...</div>
    
    <div id="channel-list"></div>
    
    <div style="display: flex; gap: 10px;">
        <button onclick="addChannelUI()" style="background: #444; color: #fff;">+ Sekundärkanal</button>
        <button onclick="doImport()" style="background: #0078d4; color: #fff;">Import (CLI/JSON)</button>
    </div>

    <button class="btn-gen" onclick="generateConfig()">URL & JSON GENERIEREN</button>

    <h3>Import URL (Anklicken zum Kopieren)</h3>
    <div class="url-box" id="url-output" onclick="copyText(this.innerText)">Generiere eine URL, um sie hier zu sehen.</div>
    
    <h3>Daten-Input/Output</h3>
    <textarea id="json-io" placeholder="Füge hier CLI 'info' Output oder JSON ein..."></textarea>
</div>

<script>
    let ProtoLib;

    // Polling-Check für die Library
    const checkInterval = setInterval(() => {
        const lib = window.meshtastic || window.Meshtastic;
        if (lib && lib.ChannelSet) {
            ProtoLib = lib.ChannelSet;
            const s = document.getElementById('status');
            s.innerText = "Library erfolgreich geladen ✅ (Version: Latest)";
            s.className = "status-indicator ready";
            clearInterval(checkInterval);
        }
    }, 250);

    function addChannelUI(data = {}) {
        const list = document.getElementById('channel-list');
        const count = list.children.length;
        const isPrimary = (count === 0 && data.role !== "SECONDARY") || data.role === "PRIMARY";
        
        const div = document.createElement('div');
        div.className = `card ${isPrimary ? 'primary' : ''}`;
        
        div.innerHTML = `
            <strong>${isPrimary ? 'PRIMARY' : 'SECONDARY'} CHANNEL</strong>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                <div><label style="font-size:11px; color:#888;">NAME</label><br>
                <input type="text" class="c-name" placeholder="z.B. Admin" value="${data.name || ''}" style="width:100%"></div>
                <div><label style="font-size:11px; color:#888;">PSK (Base64)</label><br>
                <input type="text" class="c-psk" placeholder="AQ==" value="${data.psk || 'AQ=='}" style="width:100%"></div>
            </div>
            <div class="mqtt-row">
                <span>Präzision: 
                    <select class="c-prec" style="background:#111; color:#fff; border:1px solid #444;">
                        <option value="0" ${data.moduleSettings?.positionPrecision == 0 ? 'selected' : ''}>0 (Deaktiviert)</option>
                        <option value="16" ${data.moduleSettings?.positionPrecision == 16 ? 'selected' : ''}>16 (~150m)</option>
                        <option value="32" ${data.moduleSettings?.positionPrecision == 32 ? 'selected' : ''}>32 (Genau)</option>
                    </select>
                </span>
                <label><input type="checkbox" class="c-up" ${data.uplinkEnabled ? 'checked' : ''}> Uplink</label>
                <label><input type="checkbox" class="c-down" ${data.downlinkEnabled ? 'checked' : ''}> Downlink</label>
                ${!isPrimary ? `<button onclick="this.parentElement.parentElement.remove()" style="background:none; color:#ff4444; padding:0; margin-left:auto; font-size:12px;">Entfernen</button>` : ''}
            </div>
        `;
        list.appendChild(div);
    }

    async function generateConfig() {
        if (!ProtoLib) return alert("Fehler: Library noch nicht geladen. Bitte Seite neu laden.");

        const cards = document.querySelectorAll('.card');
        const config = { channels: [] };
        const jsonPreview = [];

        cards.forEach((card, i) => {
            const pskStr = card.querySelector('.c-psk').value.trim();
            let pskBytes = new Uint8Array(0);
            try { 
                if(pskStr) {
                    const binary = atob(pskStr);
                    pskBytes = new Uint8Array(binary.length);
                    for (let x = 0; x < binary.length; x++) pskBytes[x] = binary.charCodeAt(x);
                }
            } catch(e){ console.error("PSK Fehler:", e); }

            const ch = {
                index: i,
                role: i === 0 ? 1 : 2,
                settings: {
                    name: card.querySelector('.c-name').value,
                    psk: pskBytes,
                    uplinkEnabled: card.querySelector('.c-up').checked,
                    downlinkEnabled: card.querySelector('.c-down').checked
                },
                moduleSettings: { positionPrecision: parseInt(card.querySelector('.c-prec').value) }
            };
            config.channels.push(ch);
            jsonPreview.push({
                role: i === 0 ? "PRIMARY" : "SECONDARY",
                name: ch.settings.name,
                psk: pskStr,
                uplinkEnabled: ch.settings.uplinkEnabled,
                downlinkEnabled: ch.settings.downlinkEnabled,
                moduleSettings: ch.moduleSettings
            });
        });

        try {
            const buffer = ProtoLib.encode(config).finish();
            const b64 = btoa(String.fromCharCode(...buffer)).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
            document.getElementById('url-output').innerText = `https://www.meshtastic.org/d/#${b64}`;
            document.getElementById('json-io').value = JSON.stringify(jsonPreview, null, 2);
        } catch(e) { alert("Encoding Fehler: " + e.message); }
    }

    function doImport() {
        const raw = document.getElementById('json-io').value.trim();
        if(!raw) return;
        let list = [];
        try {
            if (raw.startsWith('[')) { list = JSON.parse(raw); }
            else {
                raw.split('\n').forEach(line => {
                    const match = line.match(/\{.*\}/);
                    if (match) {
                        let j = JSON.parse(match[0]);
                        j.role = line.toUpperCase().includes("PRIMARY") ? "PRIMARY" : "SECONDARY";
                        list.push(j);
                    }
                });
            }
            if (list.length) {
                document.getElementById('channel-list').innerHTML = "";
                list.forEach(addChannelUI);
            }
        } catch(e) { alert("Import Fehler: " + e.message); }
    }

    function copyText(t) { 
        if(t.startsWith("http")) {
            navigator.clipboard.writeText(t); 
            alert("URL in Zwischenablage kopiert!"); 
        }
    }
    
    window.onload = () => addChannelUI({ role: "PRIMARY", psk: "AQ==" });
</script>
</body>
</html>
