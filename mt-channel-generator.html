<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meshtastic Generator</title>
    <script src="meshtastic.min.js"></script>
    <style>
        :root { --blue: #0078d4; --green: #28a745; --bg: #121212; --card: #1e1e1e; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #eee; padding: 20px; margin: 0; }
        .container { max-width: 800px; margin: auto; }
        .status { padding: 10px; border-radius: 5px; margin-bottom: 20px; text-align: center; font-weight: bold; font-size: 0.9em; border: 1px solid #333; }
        .ready { background: #1b3320; color: #44ff66; border-color: #2d5a35; }
        .wait { background: #332b10; color: #ffcc00; }
        .card { background: var(--card); border: 1px solid #333; padding: 15px; margin-bottom: 15px; border-radius: 8px; border-left: 5px solid var(--blue); }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        input, select, textarea { background: #2d2d2d; color: #fff; border: 1px solid #444; padding: 10px; border-radius: 4px; width: 100%; box-sizing: border-box; }
        .url-box { background: #000; color: #569cd6; padding: 15px; border: 1px dashed var(--blue); word-break: break-all; margin: 15px 0; font-family: monospace; cursor: pointer; border-radius: 5px; }
        button { cursor: pointer; border: none; border-radius: 5px; padding: 12px; font-weight: bold; transition: opacity 0.2s; }
        .btn-add { background: #444; color: white; margin-bottom: 10px; }
        .btn-gen { background: var(--green); color: white; width: 100%; font-size: 1.1em; }
        button:disabled { opacity: 0.3; cursor: not-allowed; }
        label { font-size: 0.8em; color: #aaa; }
    </style>
</head>
<body>

<div class="container">
    <h2>Meshtastic Generator <span style="color: var(--blue);">V21</span></h2>
    <div id="status" class="status wait">Warte auf lokale meshtastic.min.js...</div>
    
    <div id="channel-list"></div>
    
    <button class="btn-add" onclick="addChannel()">+ Kanal hinzufügen</button>
    <button id="gen-btn" class="btn-gen" onclick="generate()" disabled>URL GENERIEREN</button>

    <div class="url-box" id="url-output" onclick="copyText(this.innerText)">URL erscheint hier nach Generierung...</div>
    <label>JSON Export / Import:</label>
    <textarea id="json-io" rows="5"></textarea>
</div>

<script>
    let ChannelSet;

    // Überprüfung ob die Datei lokal geladen wurde
    const checkLib = setInterval(() => {
        if (window.meshtastic && window.meshtastic.ChannelSet) {
            ChannelSet = window.meshtastic.ChannelSet;
            const s = document.getElementById('status');
            s.innerText = "Library lokal geladen ✅ Bereit.";
            s.className = "status ready";
            document.getElementById('gen-btn').disabled = false;
            clearInterval(checkLib);
        }
    }, 500);

    function addChannel(data = {}) {
        const list = document.getElementById('channel-list');
        const idx = list.children.length;
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
            <strong>Kanal ${idx} (${idx === 0 ? 'PRIMARY' : 'SECONDARY'})</strong>
            <div class="row">
                <div><label>Name</label><input type="text" class="c-name" value="${data.name || ''}"></div>
                <div><label>PSK (Base64)</label><input type="text" class="c-psk" value="${data.psk || 'AQ=='}"></div>
            </div>
            <div class="row" style="font-size:0.9em;">
                <div>Prec: <select class="c-prec"><option value="0">0</option><option value="16">16</option><option value="32">32</option></select></div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <label><input type="checkbox" class="c-up" style="width:auto"> Up</label>
                    <label><input type="checkbox" class="c-down" style="width:auto"> Down</label>
                </div>
            </div>
        `;
        list.appendChild(div);
    }

    function generate() {
        if (!ChannelSet) return;
        const cards = document.querySelectorAll('.card');
        const payload = { channels: [] };
        
        cards.forEach((card, i) => {
            const pskStr = card.querySelector('.c-psk').value.trim();
            let pskBytes = new Uint8Array(0);
            try { if(pskStr) pskBytes = Uint8Array.from(atob(pskStr), c => c.charCodeAt(0)); } catch(e){}

            payload.channels.push({
                index: i,
                role: i === 0 ? 1 : 2,
                settings: {
                    name: card.querySelector('.c-name').value,
                    psk: pskBytes,
                    uplinkEnabled: card.querySelector('.c-up').checked,
                    downlinkEnabled: card.querySelector('.c-down').checked
                },
                moduleSettings: { positionPrecision: parseInt(card.querySelector('.c-prec').value) }
            });
        });

        const buffer = ChannelSet.encode(ChannelSet.create(payload)).finish();
        const b64 = btoa(String.fromCharCode(...buffer)).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        document.getElementById('url-output').innerText = "https://www.meshtastic.org/d/#" + b64;
        document.getElementById('json-io').value = JSON.stringify(payload, (k,v) => v instanceof Uint8Array ? "Base64" : v, 2);
    }

    function copyText(t) { 
        if(t.includes("http")) {
            navigator.clipboard.writeText(t); 
            alert("URL kopiert!"); 
        }
    }

    window.onload = () => addChannel();
</script>
</body>
</html>
